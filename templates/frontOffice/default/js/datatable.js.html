<script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/js/select2.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.10/lodash.min.js"></script>
<script src="https://cdn.datatables.net/1.13.1/js/jquery.dataTables.min.js"></script>
<script type="text/javascript">
    (function ($, $module) {

        const url = '{url path="/easy-datatable-manager/list" type="ZenDeskTicketsDataTable"}';

        var columnsDefinition = JSON.parse('{$columns_definition|json_encode nofilter}');
        [...columnsDefinition].forEach(el => {

            if (el.render) {
                el.render = MyTools[el.render];
            }
        });

        var table = $module.find('.js-list').DataTable({
            processing: true,
            serverSide: true,
            searching: false,
            lengthChange: false,
            scrollX: true,
            order: [[0, "desc"]],
            drawCallback: function (oSettings) {
            },
            ajax: {
                url: url,
                method: 'POST',
                data: function (data) {
                    data.search = $module.find('#js-search-element').val();
                    var filterElements = {};
                    [...document.querySelectorAll(".js-filter-element")].forEach(el => {
                        filterElements[el.name] = el.value;
                    });
                    data.filters = filterElements;
                    data.length = $module.find('#js-input-length').val();
                }
            },
            displayLength: 25,
            columnDefs: columnsDefinition
        });

        var filters = $module.find('.js-refresh-table');

        function refreshFilter() {
            filters.each(function () {
                if ('undefined' !== typeof this.dataset.default) {
                    var val = $(this).val();
                    if (val === null) {
                        val = '';
                    }

                    if (val !== this.dataset.default) {
                        $(this).parents('.filter:eq(0)').css('backgroundColor', 'rgba(0, 102, 255, 0.1)');
                    } else {
                        $(this).parents('.filter:eq(0)').css('backgroundColor', '');
                    }
                }
            });
        }

        var timer = null;
        $module.find('.js-refresh-table').on('change keyup', function (event) {
            if (event.type === "keyup") {
                if (timer !== null) {
                    clearTimeout(timer);
                }

                timer = setTimeout(function () {
                    refreshFilter();
                    table.ajax.reload();
                }, 350)
            } else {
                refreshFilter();
                table.ajax.reload();
            }
        });

        var interval = null;

        function autoRefresh() {
            var ms = 1000;

            interval = setTimeout(function () {
                table.ajax.reload(null, false);
                autoRefresh();
            }, ms)
        }

    }(jQuery, jQuery('#module-easy-datatable-manager')))
</script>
